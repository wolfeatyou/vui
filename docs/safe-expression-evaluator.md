# Safe Expression Evaluator - Руководство для разработчиков

## Общая информация

Safe Expression Evaluator предоставляет безопасный способ вычисления JavaScript-подобных выражений, возвращающих булево значение. Эти выражения могут использоваться для условий видимости, проверки прав доступа и других сценариев, где требуется динамическая оценка.

## Синтаксис выражений

### Базовые литералы

```
true                     // Логическая истина
false                    // Логическая ложь
null                     // Null значение
"строка"                 // Строковый литерал
5                        // Числовой литерал
['a', 'b', 'c']          // Массив
```

### Логические операторы

```
!выражение               // Логическое НЕ
выражение1 && выражение2 // Логическое И
выражение1 || выражение2 // Логическое ИЛИ
```

### Операторы сравнения

```
a == b                  // Равенство (без строгой типизации)
a != b                  // Неравенство (без строгой типизации)
```

### Доступ к контексту

Контекст – это объект, содержащий данные, доступные для выражения:

```
context.user.name == "John"     // Проверка свойства в объекте контекста
context.role != "admin"         // Сравнение свойства контекста
```

### Опциональная цепочка

Безопасный доступ к потенциально отсутствующим свойствам:

```
context.user?.address?.city == "Moscow"   // Не вызовет ошибку, если user или address равны null/undefined
```

### Функции API

Выражения могут использовать предопределенные функции, доступные через пространство имен `api`:

```
api.hasGrants(['edit', 'create'])         // Вызов функции api с массивом параметров
api.isInRole('admin')                     // Вызов функции api со строковым параметром
```

### Работа с массивами

```
['admin', 'editor'].includes(context.role)  // Проверка вхождения в массив
```

### Группировка

```
(a == b) && (c == d)                        // Группировка условий скобками
(context.role == 'admin') || (api.hasGrants(['edit']))  // Комбинация условий
```

## Примеры использования

### Проверка роли пользователя

```
context.role == 'admin' || context.role == 'editor'
```

### Проверка прав доступа

```
api.hasGrants(['edit', 'create']) && context.status == 'active'
```

### Проверка с условной логикой

```
(context.institution.code == 'ROS' && ['RetailChain', 'Outlet'].includes(context.role)) || context.institution.code != 'ROS'
```

### Комплексные условия с проверкой существования

```
context.agentAdditionalInfo?.rn_role == 'BankAgent' && context.status != 'deleted'
```

## Ограничения

* Поддерживаются только операторы `==` и `!=` (не поддерживаются `===`, `!==`, `>`, `<`, `>=`, `<=`)
* Не поддерживаются тернарные операторы `?:`
* Не поддерживаются арифметические операции (`+`, `-`, `*`, `/`, `%`)
* Из функций массивов поддерживается только метод `includes`
* API функции должны быть явно предоставлены через объект `api`

## Как использовать в коде

```javascript
const { evalSafeExpression } = require('./visibility-evaluator');

// Контекст с данными
const context = {
  user: { 
    id: 123, 
    name: 'John',
    role: 'editor'
  },
  institution: { 
    code: 'ROS' 
  }
};

// API функции
const api = {
  hasGrants: (roles) => roles.includes('edit'),
  isInRole: (role) => role === context.user.role
};

// Вычисление выражения
const result = evalSafeExpression(
  "context.user.role == 'admin' || api.hasGrants(['edit'])", 
  { context, api }
);

console.log(result); // true или false
```

## Безопасность

Выражения вычисляются в изолированной среде без доступа к глобальному контексту JavaScript. Это предотвращает выполнение потенциально опасного кода. Только явно предоставленные данные и функции будут доступны для выражений.

## Реализация

Для парсинга выражений используется библиотека [Acorn](https://github.com/acornjs/acorn) - легковесный и быстрый ECMAScript парсер. Выражения преобразуются в абстрактное синтаксическое дерево (AST), которое затем обрабатывается рекурсивно для получения результата.

### Установка зависимостей

```
npm install acorn
```

### Основные файлы

* `src/visibility-evaluator.js` - основной модуль с функцией `evalSafeExpression`
* `test/run-tests.js` - тесты для проверки работы оценщика выражений

## Тестирование

Для запуска тестов используйте:

```
node test/run-tests.js
```

или, если установлен Jest:

```
npx jest
``` 